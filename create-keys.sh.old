#!/bin/sh -efu

[ -d ./keys ] && exit 0

mkdir -pv keys
cd keys

for t in PK KEK DB VENDOR; do
  openssl req \
	-newkey rsa:2048 -nodes \
	-keyout "$t.key" \
	-new -x509 -sha256 -days 3650 -subj "/CN=Test Secure Boot $t CA" \
	-addext keyUsage=critical,cRLSign,digitalSignature,keyCertSign \
	-addext extendedKeyUsage=codeSigning \
	-out "$t.crt"
done

# cert for shim
openssl x509 -inform pem -in "VENDOR.crt" -outform der -out "VENDOR.cer"

# pkcs12 key to pesign shim
openssl pkcs12 -export -nodes -passout pass: \
	-out "DB.p12" -inkey "DB.key" -in "DB.crt"
pk12util -i "DB.p12" -d "$PWD" -K '' -W ''

# pkcs12 key to pesign grub
openssl pkcs12 -export -nodes -passout pass: \
	-out "VENDOR.p12" -inkey "VENDOR.key" -in "VENDOR.crt"
pk12util -i "VENDOR.p12" -d "$PWD" -K '' -W ''
